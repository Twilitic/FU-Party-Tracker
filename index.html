<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabula Ultima Party Tracker v5.1 (Alpha)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --background-blue: #000080;
            --window-bg: #1a1a5c;
            --border-light: #ffffff;
            --border-dark: #808080;
            --text-yellow: #ffff00;
            --text-cyan: #00ffff;
            --hp-color: #32cd32;
            --mp-color: #4169e1;
            --ip-color: #ff8c00;
            --crisis-color: #ef4444;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--background-blue);
            color: white;
            image-rendering: pixelated;
            background-size: cover;
            background-position: center;
        }

        .jrpg-window {
            background-color: var(--window-bg);
            border: 4px solid;
            border-image: linear-gradient(to bottom, var(--border-light), var(--border-dark)) 1;
            box-shadow: 0 0 0 4px #000;
        }

        .action-button:hover { background-color: #3a3a8c; cursor: pointer; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .scrollable-menu::-webkit-scrollbar { width: 8px; }
        .scrollable-menu::-webkit-scrollbar-track { background: #000; }
        .scrollable-menu::-webkit-scrollbar-thumb { background-color: var(--border-dark); border: 2px solid var(--border-light); }
        input, select, textarea { background-color: #000; border: 2px solid var(--border-light); color: white; padding: 0.25rem; font-family: 'Share Tech Mono', monospace; width: 100%; }
        
        /* v5.1 Layout */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #main-view {
            flex-grow: 1;
            display: grid;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #main-view.menu-right { grid-template-columns: 1fr 350px; }
        #main-view.menu-left { grid-template-columns: 350px 1fr; }
        #main-command-area { min-height: 0; }
        #main-view.menu-left #main-command-area { order: -1; }
        
        #party-status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem;
            flex-shrink: 0;
        }
        .status-panel-compact {
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .status-panel-compact:not(.focused):hover { background-color: #2a2a7c; }
        .status-panel-compact.focused { box-shadow: 0 0 0 4px #000, 0 0 10px 4px var(--text-yellow); }
        
        .status-icon { width: 20px; height: 20px; border-radius: 4px; padding: 2px; background-color: rgba(0,0,0,0.5); cursor: pointer; flex-shrink: 0; }
        .status-icon svg { opacity: 0.3; }
        .status-icon.active svg { opacity: 1; }
        
        .progress-bar-container { background-color: #000; border: 2px solid var(--border-dark); height: 20px; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
        .progress-bar { height: 100%; transition: width 0.3s ease-in-out; position: absolute; left: 0; top: 0; }
        .progress-bar-text { z-index: 1; text-shadow: 1px 1px 2px black; font-size: 0.8rem; }
        
        @media (max-width: 1024px) {
            #main-view {
                grid-template-columns: 1fr;
            }
            #main-command-area {
                max-height: 40vh; /* Limit height on mobile */
            }
            #main-view.menu-left #main-command-area { order: 0; }
        }
    </style>
</head>
<body>
    <!-- Session Management UI -->
    <div id="session-container" class="min-h-screen w-screen p-4 flex justify-content-center items-center">
        <div class="jrpg-window p-6 w-full max-w-md text-center">
            <h1 class="text-2xl text-yellow-300 mb-4">Fabula Ultima Party Tracker 5.1</h1>
            <p class="mb-6">Join a collaborative online session or use in offline mode.</p>
            <div class="space-y-4">
                <button id="create-party-btn" class="jrpg-window !p-2 action-button w-full">Create New Online Party</button>
                <input type="text" id="party-id-input" placeholder="Enter Party ID" class="text-center">
                <button id="join-party-btn" class="jrpg-window !p-2 action-button w-full">Join Online Party</button>
                <button id="offline-mode-btn" class="jrpg-window !p-2 action-button w-full bg-gray-700">Use Offline Mode</button>
            </div>
            <p id="session-error" class="text-red-500 mt-4 h-4"></p>
        </div>
    </div>
    
    <!-- Main App UI -->
    <div id="app-container" class="hidden">
        <div id="main-view">
            <div id="main-content-area" class="jrpg-window h-full">
                <!-- DM Content will go here -->
                <p class="p-4 text-center text-gray-400">Main Content Area (For DM Screen)</p>
            </div>
            <div id="main-command-area"></div>
        </div>
        <div id="party-status-bar"></div>
        <div class="absolute bottom-20 right-4 flex flex-col gap-2">
             <button data-action="toggle-edit-mode" id="edit-mode-btn" class="jrpg-window !p-2 action-button">Edit</button>
             <button data-action="open-system-menu" class="jrpg-window !p-2 action-button">System</button>
        </div>
        <div id="modal-container"></div>
    </div>

    <script>
    // F.U. Party Tracker v5.1 (Alpha)
    window.onload = () => {
        // --- CORE SETUP & STATE ---
        const firebaseConfig = { apiKey: "AIzaSyD73IhU0asC807BKVif9t6U9hIryDJlLNY", authDomain: "f-u-party-tracker.firebaseapp.com", projectId: "f-u-party-tracker", storageBucket: "f-u-party-tracker.appspot.com", messagingSenderId: "375233304595", appId: "1:375233304595:web:c306cc40667f84b86987e6" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let partyId = null, isOfflineMode = false, unsubscribeFromParty = null, saveDataTimeout = null;

        const AppState = { party: [], settings: { backgroundUrl: '' } };
        const LocalUIState = { 
            isEditMode: false, activeModal: null, focusedCharacterIndex: 0,
            activeMenuPaths: [ [], [], [], [] ],
            settings: { volume: 0.5, muted: false, commandMenuSide: 'right' } 
        };
        
        // --- CONSTANTS ---
        const STATUS_EFFECTS = {
            slow: { name: 'Slow', color: '#60a5fa', icon: 'M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z', attr: 'DEX' },
            dazed: { name: 'Dazed', color: '#facc15', icon: 'M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.116 3.986 1.518 5.671c.28 1.136-.954 2.033-1.96 1.425L12 18.354 7.373 21.18c-1.006.608-2.24-.289-1.96-1.425l1.518-5.671-4.116-3.986c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z', attr: 'INS' },
            weak: { name: 'Weak', color: '#a3a3a3', icon: 'M12 4v16m-6-6l6 6 6-6', attr: 'MIG' },
            shaken: { name: 'Shaken', color: '#6ee7b7', icon: 'M3 10l4 4 4-8 4 8 4-4', attr: 'WLP' },
            poisoned: { name: 'Poisoned', color: '#a855f7', icon: 'M12,2C6.477,2,2,6.477,2,12s4.477,10,10,10s10-4.477,10-10S17.523,2,12,2z M9.5,8C10.328,8,11,8.672,11,9.5S10.328,11,9.5,11 S8,10.328,8,9.5S8.672,8,9.5,8z M14.5,8c0.828,0,1.5,0.672,1.5,1.5S15.328,11,14.5,11S13,10.328,13,9.5S13.672,8,14.5,8z M12,18 c-2.209,0-4-1.791-4-4h8C16,16.209,14.209,18,12,18z', attr: null },
            enraged: { name: 'Enraged', color: '#ef4444', icon: 'M12.94,2.62C11.6,2.22,10.15,2,8.5,2C5.46,2,3,4.46,3,7.5c0,1.99,1.04,3.73,2.62,4.78C5.22,13.4,5,14.69,5,16v1 c0,1.1,0.9,2,2,2h7c1.1,0,2-0.9,2-2v-1c0-1.31-0.22-2.6-0.62-3.72C17.96,11.23,19,9.49,19,7.5C19,5.85,18.78,4.4,18.38,3.06 C16.92,4.98,14.77,6,12.5,6c-1.55,0-3.04-0.48-4.38-1.38C8.96,3.7,9.81,3,10.77,2.44C11.53,2.83,12.25,3.09,12.94,2.62z', attr: null }
        };
        const ATTRIBUTES = ['DEX', 'MIG', 'INS', 'WLP'];
        const DICE = ['d6', 'd8', 'd10', 'd12'];
        const FULTIMATOR_AFFINITY_MAP = { rs: 'resist', vu: 'vulnerable', im: 'immune', ab: 'absorb' };
        const FULTIMATOR_ATTRIBUTE_MAP = { 6: 'd6', 8: 'd8', 10: 'd10', 12: 'd12' };
        let sounds = null, soundInitialized = false, volumeNode;

        // --- INITIALIZATION ---
        function init() {
            document.body.addEventListener('click', initializeSounds, { once: true });
            document.getElementById('create-party-btn').addEventListener('click', createParty);
            document.getElementById('join-party-btn').addEventListener('click', joinParty);
            document.getElementById('offline-mode-btn').addEventListener('click', startOfflineMode);
            document.body.addEventListener('click', handleGlobalClick);
            
            const lastPartyId = localStorage.getItem('fabulaUltimaLastPartyId');
            if (lastPartyId) {
                document.getElementById('party-id-input').value = lastPartyId;
                joinParty(true);
            }
        }
        
        // --- SESSION & DATA ---
        function transitionToApp() {
            LocalUIState.activeModal = null;
            LocalUIState.focusedCharacterIndex = 0;
            document.getElementById('session-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            renderAll();
        }

        async function createParty() {
            const newPartyId = `${["Crimson", "Azure", "Golden", "Emerald"][Math.floor(Math.random() * 4)]}-${["Wyvern", "Golem", "Mage", "Knight"][Math.floor(Math.random() * 4)]}-${Math.floor(Math.random() * 100)}`.toLowerCase();
            partyId = newPartyId; isOfflineMode = false;
            const defaultState = { party: Array.from({ length: 4 }, (_, i) => createDefaultCharacter(i)), settings: { backgroundUrl: '' }, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            Object.assign(AppState, defaultState);
            await db.collection('parties').doc(partyId).set(defaultState);
            localStorage.setItem('fabulaUltimaLastPartyId', partyId);
            listenToPartyChanges();
            transitionToApp();
        }

        async function joinParty(isAutoRejoin = false) {
            const inputId = document.getElementById('party-id-input').value.trim().toLowerCase();
            if (!inputId) { document.getElementById('session-error').textContent = "Please enter a Party ID."; return; }
            if (inputId === 'ooble-loodle bloodle-doo') return showAdminPanel();
            
            document.getElementById('session-error').textContent = "Connecting...";
            try {
                const doc = await db.collection('parties').doc(inputId).get();
                if (doc.exists) {
                    partyId = inputId; isOfflineMode = false;
                    localStorage.setItem('fabulaUltimaLastPartyId', partyId);
                    if (unsubscribeFromParty) unsubscribeFromParty();
                    listenToPartyChanges();
                    transitionToApp();
                } else {
                    document.getElementById('session-error').textContent = "Party ID not found.";
                    if (isAutoRejoin) localStorage.removeItem('fabulaUltimaLastPartyId');
                }
            } catch (error) { console.error("Error joining party:", error); document.getElementById('session-error').textContent = "Connection error."; }
        }
        
        async function showAdminPanel() {
             LocalUIState.activeModal = { type: 'admin-panel', data: { isLoading: true, sessions: [] } };
             renderModal();
             try {
                const querySnapshot = await db.collection('parties').get();
                const sessions = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                LocalUIState.activeModal.data = { isLoading: false, sessions };
            } catch(error) { LocalUIState.activeModal.data = { isLoading: false, sessions: [], error: error.message }; }
            renderModal();
        }

        function startOfflineMode() {
            isOfflineMode = true; partyId = null;
            const savedData = localStorage.getItem('fabulaUltimaOfflineSheet');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                Object.assign(AppState, parsed.appState);
                Object.assign(LocalUIState.settings, parsed.localSettings);
            } else { AppState.party = Array.from({ length: 4 }, (_, i) => createDefaultCharacter(i)); }
            transitionToApp();
        }

        function saveData() {
            if (isOfflineMode) { localStorage.setItem('fabulaUltimaOfflineSheet', JSON.stringify({appState: AppState, localSettings: LocalUIState.settings})); return; }
            if (!partyId) return;
            clearTimeout(saveDataTimeout);
            saveDataTimeout = setTimeout(() => {
                const { party, settings } = AppState;
                db.collection('parties').doc(partyId).set({ party, settings }, { merge: true }).catch(e => console.error("Firestore save error:", e));
            }, 300);
        }

        function listenToPartyChanges() {
            unsubscribeFromParty = db.collection('parties').doc(partyId).onSnapshot(doc => {
                if (doc.exists) {
                    const cloudState = doc.data();
                    AppState.party = cloudState.party || [];
                    AppState.settings = cloudState.settings || { backgroundUrl: '' };
                    renderAll();
                } else { alert("This party session has been deleted remotely."); leaveSession(true); }
            }, error => { console.error("Firestore listener error:", error); alert("Connection to party session lost. Please refresh."); });
        }
        
        function leaveSession(forceReload = false) {
            if (unsubscribeFromParty) unsubscribeFromParty();
            localStorage.removeItem('fabulaUltimaLastPartyId');
            if (forceReload) location.reload();
        }

        // --- DATA STRUCTURES & PARSING ---
        function createDefaultCharacter(id) { /* ... same as v5.0 ... */ return { id, name: `Hero ${id + 1}`, portrait: `https://placehold.co/100x100/1a1a5c/ffffff?text=P${id + 1}`, stats: { hp: { current: 50, max: 50 }, mp: { current: 20, max: 20 }, ip: { current: 6, max: 6 } }, def: 10, mdef: 10, attributes: { DEX: 'd6', INS: 'd6', MIG: 'd6', WLP: 'd6' }, status: Object.keys(STATUS_EFFECTS).reduce((acc, key) => ({...acc, [key]: false}), {}), resistances: {}, temporaryEffects: [], equipment: { armor: [], shields: [] }, commands: [ { name: 'Attack', type: 'category', isCollapsed: false, items: [{ name: 'Basic Attack', type: 'item', costType: 'None', costValue: 0, targeting: '1 Target', description: 'A standard physical attack.', effects: [{type: 'damage', formula: 'MIG', resource: 'HP', damageType: 'physical'}] }] }, { name: 'Items', type: 'category', isCollapsed: false, items: [ { name: 'Remedy', type: 'item', costType: 'IP', costValue: 3, targeting: '1 Target', description: 'Recover 50 HP.', effects: [{type: 'heal', formula: '50', resource: 'HP'}]}, { name: 'Elixir', type: 'item', costType: 'IP', costValue: 3, targeting: '1 Target', description: 'Recover 50 MP.', effects: [{type: 'heal', formula: '50', resource: 'MP'}]}, { name: 'Tonic', type: 'item', costType: 'IP', costValue: 2, targeting: '1 Target', description: 'Cure one status effect.', effects: [{type: 'dispel', dispelType: 'status'}]}, { name: 'Magic Tent', type: 'item', costType: 'IP', costValue: 4, targeting: 'All Targets', description: 'Fully restore HP and MP, and cure all statuses for the party.', effects: [{type: 'heal', formula: '9999', resource: 'HP'}, {type: 'heal', formula: '9999', resource: 'MP'}, {type: 'dispel', dispelType: 'status'}]}, ] } ], customization: { nameColor: '#ffff00' } }; }
        function parseFultimatorJson(jsonString) { /* ... same as v5.0 ... */ try { const data = JSON.parse(jsonString); if (data.dataType !== 'pc') throw new Error("Not a Fultimator PC file."); const newChar = createDefaultCharacter(0); newChar.name = data.name || 'Imported Hero'; newChar.portrait = data.info.imgurl || newChar.portrait; newChar.stats = { hp: data.stats.hp, mp: data.stats.mp, ip: data.stats.ip }; newChar.attributes = { DEX: FULTIMATOR_ATTRIBUTE_MAP[data.attributes.dexterity] || 'd6', INS: FULTIMATOR_ATTRIBUTE_MAP[data.attributes.insight] || 'd6', MIG: FULTIMATOR_ATTRIBUTE_MAP[data.attributes.might] || 'd6', WLP: FULTIMATOR_ATTRIBUTE_MAP[data.attributes.willpower] || 'd6' }; newChar.resistances = {}; if (data.affinities) { for (const [type, value] of Object.entries(data.affinities)) { if (FULTIMATOR_AFFINITY_MAP[value]) newChar.resistances[type] = FULTIMATOR_AFFINITY_MAP[value]; } } let totalDef = 0, totalMdef = 0; const equippedArmor = data.armor?.filter(a => a.isEquipped) || []; const equippedShields = data.shields?.filter(s => s.isEquipped) || []; newChar.equipment = { armor: equippedArmor, shields: equippedShields }; [...equippedArmor, ...equippedShields].forEach(item => { totalDef += (item.def || 0); totalMdef += (item.mdef || 0); }); newChar.def = totalDef; newChar.mdef = totalMdef; newChar.commands = (data.classes || []).map(cls => ({ name: cls.name, type: 'category', isCollapsed: false, items: (cls.spells || []).concat(cls.skills || []).map(s => ({ name: s.name || s.skillName, type: 'item', costType: s.mp ? 'MP' : (s.ip ? 'IP' : 'None'), costValue: s.mp || s.ip || 0, targeting: s.maxTargets > 1 ? `${s.maxTargets} Targets` : '1 Target', description: s.description, effects: parseDescriptionForEffects(s.description) })) })).filter(cat => cat.items.length > 0); return newChar; } catch (error) { console.error("Fultimator Parse Error:", error); playSound('error'); return null; } }
        function parseDescriptionForEffects(desc) { /* ... same as v5.0 ... */ if (!desc) return []; const effects = []; const cleanDesc = desc.replace(/<\/?strong>/g, ''); const damageRegex = /【([^】]+)】\s*(\w+)\s*damage/g; let match; while ((match = damageRegex.exec(cleanDesc)) !== null) { effects.push({ type: 'damage', formula: match[1].replace(/\s/g, ''), damageType: match[2].toLowerCase(), resource: 'HP', ignoresResistance: cleanDesc.toLowerCase().includes('ignores resistances') }); } if (effects.length === 0) effects.push({ type: 'misc', description: desc }); return effects; }

        // --- RENDER FUNCTIONS (v5.1) ---
        function renderAll() {
            if (!AppState.party || AppState.party.length === 0) return;
            document.body.style.backgroundImage = AppState.settings.backgroundUrl ? `url('${AppState.settings.backgroundUrl}')` : '';
            document.getElementById('main-view').className = `flex-grow grid gap-4 p-4 min-h-0 menu-${LocalUIState.settings.commandMenuSide}`;
            renderPartyStatusBar();
            renderMainCommandArea();
            renderModal();
        }

        function renderPartyStatusBar() {
            document.getElementById('party-status-bar').innerHTML = AppState.party.map((char, index) => {
                const isFocused = index === LocalUIState.focusedCharacterIndex;
                const isCrisis = char.stats.hp.current <= Math.floor(char.stats.hp.max / 2);
                
                return `
                <div class="jrpg-window p-2 status-panel-compact ${isFocused ? 'focused' : ''}" data-action="set-focus" data-char-index="${index}">
                    <div class="flex gap-2 items-center">
                        <img src="${char.portrait}" class="w-12 h-12 object-cover border-2 border-white flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <h3 class="text-lg truncate" style="color:${char.customization.nameColor};">${char.name}</h3>
                            <div class="text-sm">DEF: ${char.def} | M.DEF: ${char.mdef}</div>
                        </div>
                         <div class="flex flex-col gap-1 pr-1">
                            ${renderStatusIcon(char, index, 'enraged')}
                            ${renderStatusIcon(char, index, 'poisoned')}
                        </div>
                    </div>
                    <div class="space-y-1 mt-2">
                        ${['hp', 'mp', 'ip'].map(stat => {
                            const s = char.stats[stat];
                            const percent = s.max > 0 ? (s.current / s.max) * 100 : 0;
                            const colorVar = (stat === 'hp' && isCrisis) ? '--crisis-color' : `--${stat}-color`;
                            return `
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width:${percent}%; background-color: var(${colorVar});"></div>
                                    <span class="progress-bar-text">${s.current}/${s.max}</span>
                                </div>`;
                        }).join('')}
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 text-sm mt-1">
                        ${ATTRIBUTES.map(attr => `
                            <div class="flex items-center justify-between">
                                <span>${attr}: <span class="${isAttributeAffected(char, attr) ? 'text-red-500' : ''}">${getAttributeWithStatus(char, attr)}</span></span>
                                ${renderStatusIcon(char, index, Object.keys(STATUS_EFFECTS).find(k => STATUS_EFFECTS[k].attr === attr))}
                            </div>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderMainCommandArea() {
            const container = document.getElementById('main-command-area');
            const char = AppState.party[LocalUIState.focusedCharacterIndex];
            if (!char) { container.innerHTML = ''; return; }
            
            const path = LocalUIState.activeMenuPaths[LocalUIState.focusedCharacterIndex];
            const items = getItemsFromPath(char, path);
            
            const namePart = `<span class="breadcrumb-item" data-action="go-to-path" data-path="">${char.name}</span>`;
            let breadcrumbs = namePart;
            // Simplified breadcrumb logic for now
            
            container.innerHTML = `
                <div class="jrpg-window p-4 h-full flex flex-col">
                    <h2 class="text-2xl text-yellow-300 mb-2 truncate">${breadcrumbs}</h2>
                    <div class="flex-grow overflow-y-auto scrollable-menu pr-2">
                        ${path.length === 0 && LocalUIState.isEditMode ? `<div class="p-2 text-xl menu-item text-green-400" data-action="edit-character" data-char-index="${LocalUIState.focusedCharacterIndex}">..Edit Character</div>` : ''}
                        ${items.map((item, itemIndex) => {
                            if (item.type === 'category') {
                                return `<div class="p-2 text-xl menu-item" data-action="open-menu" data-char-index="${LocalUIState.focusedCharacterIndex}" data-item-index="${itemIndex}">${item.name}</div>`;
                            }
                            return `<div class="p-2 text-lg menu-item flex justify-between"><span>${item.name}</span> <span>${formatCost(item)}</span></div>`;
                        }).join('')}
                    </div>
                     ${path.length > 0 ? `<div class="mt-2 text-center"><button class="text-cyan-300 text-lg action-button p-1" data-action="go-back" data-char-index="${LocalUIState.focusedCharacterIndex}">..Back</button></div>` : ''}
                </div>`;
        }

        function renderModal() {
             const container = document.getElementById('modal-container');
             if (!LocalUIState.activeModal) { container.innerHTML = ''; return; }
             const { type, data } = LocalUIState.activeModal;
             let content = '';

             if (type === 'admin-panel') content = getAdminPanelContent(data);
             else if (type === 'system-menu') content = getSystemMenuContent();
             else if (type === 'edit-character') content = getEditCharacterModalContent(data);
             else content = `<div class="jrpg-window p-4"><p>Modal: ${type}</p><button data-action="close-modal">Close</button></div>`;
             
             container.innerHTML = `<div class="modal-backdrop" data-action="close-modal-backdrop">${content}</div>`;
             addModalEventListeners(type, data);
        }
        
        function getAdminPanelContent({ isLoading, sessions, error }) { /* ... same as v5.0 ... */ let listContent; if (isLoading) listContent = `<p>Loading...</p>`; else if (error) listContent = `<p class="text-red-500">${error}</p>`; else listContent = sessions.map(s => ` <div class="bg-black/20 p-2 flex justify-between items-center"> <div> <p class="font-bold">${s.id}</p> <p class="text-sm text-gray-400">${s.party.map(p=>p.name).join(', ')}</p> </div> <div class="flex gap-2"> <button class="jrpg-window !p-1 action-button" data-action="admin-join" data-party-id="${s.id}">Join</button> <button class="jrpg-window !p-1 action-button bg-red-800" data-action="admin-delete" data-party-id="${s.id}">Del</button> </div> </div> `).join(''); return ` <div class="jrpg-window p-4 w-full max-w-xl"> <h2 class="text-yellow-300 text-xl mb-4">Admin Panel</h2> <div class="space-y-2 max-h-96 overflow-y-auto scrollable-menu pr-2">${listContent}</div> <div class="mt-4 text-center"><button class="jrpg-window !p-2 action-button" data-action="close-admin-panel">Close & Reload</button></div> </div>`; }
        function getEditCharacterModalContent({ char, charIndex }) { /* ... same as v5.0 ... */ return ` <div class="jrpg-window p-4 w-full max-w-lg"> <h2 class="text-yellow-300 text-xl mb-4">Edit ${char.name}</h2> <p class="mb-4">Character editor is a work in progress.</p> <button class="jrpg-window !p-2 action-button w-full" data-action="import-fultimator" data-char-index="${charIndex}">Import Fultimator JSON</button> <input type="file" class="hidden" id="fultimator-import-${charIndex}" accept=".json"> <div class="mt-4 text-center"><button class="jrpg-window !p-2 action-button" data-action="close-modal">Close</button></div> </div> `; }
        function getSystemMenuContent() {
            return `
            <div class="jrpg-window p-4 w-full max-w-md">
                <h2 class="text-yellow-300 text-xl mb-4">System Settings</h2>
                <div class="space-y-4">
                    <div>
                        <p class="mb-2 text-center">Command Menu Side</p>
                        <div class="flex justify-center gap-4">
                            <button data-action="set-menu-side" data-side="left" class="jrpg-window !p-2 action-button ${LocalUIState.settings.commandMenuSide === 'left' ? 'bg-blue-900' : ''}">Left</button>
                            <button data-action="set-menu-side" data-side="right" class="jrpg-window !p-2 action-button ${LocalUIState.settings.commandMenuSide === 'right' ? 'bg-blue-900' : ''}">Right</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center"><button class="jrpg-window !p-2 action-button" data-action="close-modal">Close</button></div>
            </div>`;
        }
        
        // --- HELPERS ---
        function getItemsFromPath(char, path) { let c = char.commands; for (const i of path) { if (c?.[i]?.items) { c = c[i].items; } else return []; } return c; }
        function getAttributeWithStatus(char, attr) { let p = 0; if (char.status.slow && attr === 'DEX') p++; if (char.status.dazed && attr === 'INS') p++; if (char.status.weak && attr === 'MIG') p++; if (char.status.shaken && attr === 'WLP') p++; if (char.status.poisoned && (attr === 'MIG' || attr === 'WLP')) p++; if (char.status.enraged && (attr === 'DEX' || attr === 'INS')) p++; const i = DICE.indexOf(char.attributes[attr]); return DICE[Math.max(0, i - p)]; }
        function isAttributeAffected(char, attr) { return char.attributes[attr] !== getAttributeWithStatus(char, attr); }
        function renderStatusIcon(char, charIndex, statusKey) { if (!statusKey) return '<span></span>'; const status = STATUS_EFFECTS[statusKey]; return `<div class="status-icon ${char.status[statusKey] ? 'active' : ''}" style="${char.status[statusKey] ? `background-color:${status.color};` : ''}" title="${status.name}" data-action="toggle-status" data-char-index="${charIndex}" data-status="${statusKey}"><svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="${status.icon}" /></svg></div>`; }
        function formatCost(item) { if (!item.costType || item.costType === 'None') return ''; const colorVar = `--${item.costType.toLowerCase()}-color`; return `<span style="color:var(${colorVar})">${item.costValue} ${item.costType}</span>`; }
        function initializeSounds() { /* ... same as before ... */ }
        function playSound(sound) { /* ... same as before ... */ }

        // --- EVENT HANDLING ---
        function handleGlobalClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            if (LocalUIState.activeModal && !target.closest('.modal-backdrop > div') && action !== 'close-modal-backdrop') return;
            const { action, charIndex, ...data } = target.dataset;
            const cIndex = parseInt(charIndex);

            const actions = {
                'set-focus': () => { if (LocalUIState.focusedCharacterIndex !== cIndex) { LocalUIState.focusedCharacterIndex = cIndex; renderAll(); } },
                'open-menu': () => { LocalUIState.activeMenuPaths[cIndex].push(parseInt(data.itemIndex)); renderMainCommandArea(); },
                'go-back': () => { LocalUIState.activeMenuPaths[cIndex].pop(); renderMainCommandArea(); },
                'open-system-menu': () => { LocalUIState.activeModal = {type: 'system-menu'}; renderModal(); },
                'toggle-edit-mode': () => { LocalUIState.isEditMode = !LocalUIState.isEditMode; renderAll(); document.getElementById('edit-mode-btn').classList.toggle('bg-green-700', LocalUIState.isEditMode); },
                'edit-character': () => { LocalUIState.activeModal = {type: 'edit-character', data: {char: AppState.party[cIndex], charIndex: cIndex}}; renderModal(); },
                'close-modal': () => { LocalUIState.activeModal = null; renderModal(); },
                'close-modal-backdrop': () => { if (e.target.classList.contains('modal-backdrop')) actions['close-modal'](); },
                'close-admin-panel': () => location.reload(),
                'toggle-status': () => { AppState.party[cIndex].status[data.status] = !AppState.party[cIndex].status[data.status]; saveData(); },
                'import-fultimator': () => document.getElementById(`fultimator-import-${cIndex}`).click(),
                'admin-join': () => { document.getElementById('party-id-input').value = data.partyId; joinParty(); },
                'admin-delete': async () => { await db.collection('parties').doc(data.partyId).delete(); showAdminPanel(); },
                'set-menu-side': () => { LocalUIState.settings.commandMenuSide = data.side; renderAll(); if(isOfflineMode) saveData(); }
            };
            if (actions[action]) actions[action]();
        }

        function addModalEventListeners(type, data) {
            if (type === 'edit-character') {
                const { charIndex } = data;
                document.getElementById(`fultimator-import-${charIndex}`).addEventListener('change', e => {
                    if (!e.target.files[0]) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const importedChar = parseFultimatorJson(event.target.result);
                        if (importedChar) {
                            importedChar.id = AppState.party[charIndex].id;
                            AppState.party[charIndex] = importedChar;
                            saveData(); playSound('confirm');
                            LocalUIState.activeModal = null;
                            renderAll();
                        }
                    };
                    reader.readAsText(e.target.files[0]);
                });
            }
        }
        
        init();
    };
    </script>
</body>
</html>
